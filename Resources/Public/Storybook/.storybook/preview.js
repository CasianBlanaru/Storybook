import { FluidTemplate } from '../../JavaScript/FluidTemplate.ts';
import { fetchTypo3Record } from '../../JavaScript/Typo3Data.ts';

// @ts-ignore
window.FluidTemplate = FluidTemplate;
// @ts-ignore
window.fetchTypo3Record = fetchTypo3Record;

export const parameters = {
  actions: { argTypesRegex: "^on[A-Z].*" },
  controls: {
    matchers: {
      color: /(background|color)$/i,
      date: /Date$/,
    },
  },
};

// Initial globalTypes - keep existing ones like theme
export let globalTypes = {
  theme: {
    name: 'Theme',
    description: 'Global theme for components',
    defaultValue: 'light',
    toolbar: {
      icon: 'paintbrush',
      items: [
        { value: 'light', title: 'Light Mode' },
        { value: 'dark', title: 'Dark Mode' },
      ],
      showName: true,
      dynamicTitle: true,
    },
  },
  // Note: The global dynamic template selector via toolbar was deemed too complex for this basic step.
  // Instead, manifest data is loaded globally and used by individual stories.
};

// Fetch manifest and store it globally
// @ts-ignore
window.templateManifestData = { error: 'Manifest not yet loaded.', templates: [], partials: [], layouts: [] }; // Initialize with empty/error state

fetch('/template-manifest.json') // Assumes manifest is in Storybook's public path
  .then(response => {
    if (response.ok) {
      return response.json();
    }
    // If 404 or other error, the manifest likely hasn't been generated by the CLI command.
    throw new Error('Template manifest not found or invalid. Run TYPO3 CLI: "storybook:generate-manifest" and ensure it is in the Storybook static path.');
  })
  .then(data => {
    // @ts-ignore
    window.templateManifestData = data;
    console.log('Template manifest loaded successfully for Storybook stories.', data);
    // Note: Storybook stories defined before this async operation completes might not see the data
    // immediately in their module-level scope. A page refresh might be needed after manifest generation.
  })
  .catch(error => {
    console.warn('Could not load template-manifest.json:', error.message);
    // @ts-ignore
    window.templateManifestData = { error: error.message, templates: [], partials: [], layouts: [] };
  });


const applyTheme = (theme) => {
  document.documentElement.setAttribute('data-theme', theme);
};

export const decorators = [
  (StoryFn, context) => {
    const { theme } = context.globals;
    applyTheme(theme);
    return StoryFn();
  },
];
