# Using Fluid ViewHelpers in Storybook

This document explains how Fluid ViewHelpers, including custom ones, are expected to work when rendering templates via the Storybook integration, which uses TYPO3's `StandaloneView` on the backend.

## Overview

TYPO3's `StandaloneView` is capable of rendering Fluid templates along with their associated ViewHelpers. This means that most standard Fluid ViewHelpers (from `typo3/cms-fluid` or `typo3/cms-core`) and custom ViewHelpers registered in your TYPO3 project should be usable in templates previewed in Storybook.

## How it Works

1.  **ViewHelper Registration**: TYPO3's system for discovering and registering ViewHelpers (based on namespaces like `f:`, `v:`, or your custom `myvendor:`) is active when `StandaloneView` is used.
2.  **Rendering Context**: `StandaloneView` initializes a rendering context that allows ViewHelpers to be resolved and executed.
3.  **Passing Arguments**: Arguments required by ViewHelpers can be supplied through the `variables` object passed to the `FluidTemplate()` function in your Storybook stories. These variables become part of the Fluid template's rendering context.

## Using Standard Fluid ViewHelpers

Standard Fluid ViewHelpers like `<f:if>`, `<f:for>`, `<f:format.html />`, `<f:image />` (with appropriate image objects passed as variables), etc., should work as expected, provided all their required arguments are supplied.

## Using Custom Fluid ViewHelpers

Custom ViewHelpers developed for your project (e.g., residing in `yourext/Classes/ViewHelpers/`) should also be usable.

**Example Scenario:**

Suppose you have a custom ViewHelper `<myvendor:myLink title="Click me" targetPageUid="{uid}" />` that generates a link based on a TYPO3 page UID.

**1. Your Custom ViewHelper (`MyLinkViewHelper.php` - simplified):**
   ```php
   <?php
   namespace MyVendor\MyExtension\ViewHelpers;
   use TYPO3Fluid\Fluid\Core\ViewHelper\AbstractTagBasedViewHelper;

   class MyLinkViewHelper extends AbstractTagBasedViewHelper {
       protected $tagName = 'a';

       public function initializeArguments() {
           parent::initializeArguments();
           $this->registerArgument('title', 'string', 'Link title', true);
           $this->registerArgument('targetPageUid', 'int', 'Target Page UID', true);
           // ... other arguments
       }

       public function render() {
           $title = $this->arguments['title'];
           $pageUid = (int)$this->arguments['targetPageUid'];

           // In a real ViewHelper, you'd use UriBuilder here
           $link = '#'; // Placeholder for actual link generation
           // $uriBuilder = $this->renderingContext->getControllerContext()->getUriBuilder();
           // $link = $uriBuilder->reset()->setTargetPageUid($pageUid)->build();

           $this->tag->addAttribute('href', $link);
           $this->tag->setContent($title);
           return $this->tag->render();
       }
   }
   ```
   *(Note: True link generation often requires `ControllerContext` and `UriBuilder`, which might need careful setup or might be limited in a pure `StandaloneView` if not properly contextualized by the API endpoint. See "Limitations" below.)*

**2. Fluid Template Snippet (`MyComponentWithCustomVH.html`):**
   ```html
   <div xmlns:myvendor="http://typo3.org/ns/MyVendor/MyExtension/ViewHelpers">
       <p>Here's a special link generated by our ViewHelper:</p>
       <myvendor:myLink title="{linkLabel}" targetPageUid="{linkTargetUid}" />
   </div>
   ```

**3. Storybook Story (`MyComponentWithCustomVH.stories.js`):**
   ```javascript
   // ...
   export const WithCustomViewHelper = Template.bind({});
   WithCustomViewHelper.args = {
     templatePath: 'EXT:my_extension/Resources/Private/Templates/MyComponentWithCustomVH.html',
     headline: 'Testing Custom ViewHelper',
     // Variables for the ViewHelper's arguments
     linkLabel: 'Go to Important Page',
     linkTargetUid: 123,
   };
   ```
   In this story, `linkLabel` and `linkTargetUid` are passed as variables. The Fluid template then uses these to supply the `title` and `targetPageUid` arguments to `myvendor:myLink`.

## Limitations and Considerations

-   **Context Dependency**: Some ViewHelpers, especially complex custom ones, might rely heavily on a fully initialized TYPO3 frontend context (e.g., `TypoScriptFrontendController` (TSFE), page configuration, user session, full Extbase controller context). `StandaloneView`, as used by the `/api/fluid/render` endpoint, provides a more isolated rendering environment.
    -   ViewHelpers that need specific TSFE properties or full Extbase persistence/plugin context might not work as expected or could throw errors if that context isn't available or properly mocked/simulated by the API endpoint.
    -   The current API endpoint (`FluidRenderApiController`) does not perform extensive context setup beyond what `StandaloneView` does by default.
-   **Database Access**: ViewHelpers performing direct database queries should work, as TYPO3's DBAL is generally available. However, be mindful of data context (e.g., PID selection, language overlays) which might not be automatically set up as in a full frontend request.
-   **Link Generation (`UriBuilder`)**: ViewHelpers generating links using `UriBuilder` might require the `ControllerContext` to be properly set on the `RenderingContext`. The API endpoint might need enhancements to provide a basic `ControllerContext` if complex link generations are common.
-   **Stateful Operations**: ViewHelpers that rely on or modify global state or session data might behave differently or cause unexpected issues in the context of Storybook previews, which are meant to be relatively stateless component showcases.

## Best Practices for Testable ViewHelpers

-   Design ViewHelpers to be as stateless as possible.
-   Clearly define their arguments and dependencies.
-   If context is needed, try to make it injectable or check for its availability gracefully.
-   For Storybook, ensure all necessary data for the ViewHelper to function is passed via the `variables` argument in your stories.

By understanding these points, you can effectively use many of your project's Fluid ViewHelpers within Storybook for component development and testing. If a ViewHelper doesn't work, analyze its dependencies and the context it requires.
---

## Other Advanced Fluid Features

Besides ViewHelpers, Fluid offers other powerful features that are generally supported when rendering templates via `StandaloneView` in this Storybook integration.

### Inline Syntax (Chaining ViewHelpers)

Fluid's inline syntax, which allows chaining ViewHelpers (often data processing or formatting ViewHelpers), is processed by the Fluid engine and should work as expected.

**Example:**
```html
<p>Original: {myText}</p>
<p>Uppercase: {myText -> f:format.case(mode: 'upper')}</p>
<p>HTML Characters Escaped: {myHtmlContent -> f:format.htmlspecialchars()}</p>
<p>Number of items in array: {myItemsArray -> f:count()}</p>
```
To test this in Storybook, simply pass `myText`, `myHtmlContent`, and `myItemsArray` as variables to your template.

### Partials

Rendering template partials using `<f:render partial="MyPartial" arguments="{...}" />` is fully supported. `StandaloneView` resolves partials based on conventional paths (e.g., `Resources/Private/Partials/` within the same extension or other configured `partialRootPaths`).

**Example Structure:**

-   **Template (`MyComponent.html`):**
    ```html
    <div>
        <h3>Main Component Content</h3>
        <f:render partial="UserInfo" arguments="{user: currentUser}" />
    </div>
    ```
-   **Partial (`UserInfo.html` in `Resources/Private/Partials/`):**
    ```html
    <div>
        <p>User: {user.name}</p>
        <p>Email: {user.email}</p>
    </div>
    ```
This was also demonstrated in the "More Complex Example" in the main `README.md`.

### Layouts

Fluid layouts, defined using `<f:layout name="MyLayoutName" />` in a template and creating corresponding layout files (e.g., `Resources/Private/Layouts/MyLayoutName.html`), are also a standard feature of `StandaloneView` and are supported.

**Example Structure:**

-   **Layout File (`Resources/Private/Layouts/SimpleLayout.html`):**
    ```html
    <div class="page-container" style="border: 1px solid navy; padding: 1em;">
        <header>
            <h1>Site Layout Header</h1>
            <!-- Example of a cObject, may or may not render depending on TS context -->
            <p>Title: <f:cObject typoscriptObjectPath="lib.siteTitle">Default Site Title</f:cObject></p>
        </header>
        <main class="content">
            <f:render section="MainContent" />
        </main>
        <footer>
            <p>&copy; 2023 My Site</p>
        </footer>
    </div>
    ```

-   **Template File Using the Layout (`Resources/Private/Templates/PageWithLayout.html`):**
    ```html
    <f:layout name="SimpleLayout" />

    <f:section name="MainContent">
        <h2>{pageHeadline}</h2>
        <p>This is the primary content for this page, rendered within the "SimpleLayout".</p>
        <p>Some text: {myTextValue -> f:format.case(mode: 'upper')}</p>
    </f:section>
    ```

-   **Storybook Story:**
    To render `PageWithLayout.html` in Storybook, you would pass `pageHeadline` and `myTextValue` as variables:
    ```javascript
    // In SomePage.stories.js
    Default.args = {
      templatePath: 'EXT:my_extension/Resources/Private/Templates/PageWithLayout.html',
      pageHeadline: 'Welcome to This Page!',
      myTextValue: 'sample content for uppercase conversion.'
    };
    ```
    The `StandaloneView` will automatically find and apply `SimpleLayout.html` (assuming it's in the conventional `Layouts` directory of the same extension).

**Note on cObjects and TypoScript:**
Features like `<f:cObject />` within layouts or templates rely on TypoScript being available and configured in the context where `StandaloneView` is initialized. The default API endpoint for this Storybook integration has a basic setup. If complex TypoScript objects are needed, the API endpoint logic might need to be extended to provide a more complete TypoScript context to `StandaloneView`.

By leveraging these advanced Fluid features, you can build and preview complex, well-structured components and page templates from within Storybook.
```
